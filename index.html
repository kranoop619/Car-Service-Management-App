<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Service Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .tab-button.active { background-color: #10b981; color: white; }
    </style>
</head>
<body>

<div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800">Service Business Manager</h1>
        <p class="text-lg text-gray-500">Track jobs, expenses, and salaries in real-time.</p>
    </header>

    <!-- Success/Error Message Box -->
    <div id="message-box" class="hidden p-4 mb-6 text-sm rounded-lg" role="alert"></div>

    <!-- Auth Container -->
    <div id="auth-container" class="mb-6 flex justify-between items-center bg-white p-4 rounded-xl shadow-lg border border-gray-100">
        <div id="loading" class="text-yellow-700 font-semibold p-2">Initializing app...</div>
        
        <!-- User Info Display -->
        <div id="user-info" class="hidden text-right">
            <p id="user-display-name" class="font-semibold text-gray-800"></p>
            <p id="auth-status" class="text-xs text-gray-500"></p>
        </div>

        <!-- Auth Buttons -->
        <button id="sign-in-button" class="hidden py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md flex items-center space-x-2" onclick="signInWithGoogle()">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <!-- Google Icon SVG path (simplified for brevity) -->
                <path d="M12.24 10.21l1.85-.01c.07-.65.26-1.34.6-2.03-.68-.53-1.68-.84-2.75-.84-2.6 0-4.73 2.13-4.73 4.73s2.13 4.73 4.73 4.73c1.37 0 2.58-.5 3.55-1.48l1.37 1.37c-1.35 1.25-3.08 1.98-4.92 1.98-4.73 0-8.56-3.83-8.56-8.56s3.83-8.56 8.56-8.56c2.47 0 4.74 1.05 6.3 2.68l.05.05L19 5.86l.06.06c1.07 1.15 1.7 2.69 1.7 4.35 0 .54-.05 1.05-.15 1.54z"/>
            </svg>
            <span>Sign In with Google</span>
        </button>
        <button id="sign-out-button" class="hidden py-2 px-4 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition duration-150 shadow-md" onclick="signOutUser()">
            Sign Out
        </button>
    </div>

    <!-- Main App Content Wrapper - Hidden until sign-in -->
    <div id="main-content-wrapper" class="hidden">
        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-jobs" class="tab-button p-3 text-lg font-semibold text-gray-600 rounded-t-lg hover:text-green-600 transition duration-150 active" onclick="showTab('jobs-entry')">Job Entry (Income)</button>
            <button id="tab-expenses" class="tab-button p-3 text-lg font-semibold text-gray-600 rounded-t-lg hover:text-green-600 transition duration-150" onclick="showTab('expenses-entry')">Expenses & Salaries</button>
            <button id="tab-reports" class="tab-button p-3 text-lg font-semibold text-gray-600 rounded-t-lg hover:text-green-600 transition duration-150" onclick="showTab('reports')">Reports</button>
            <button id="tab-master" class="tab-button p-3 text-lg font-semibold text-gray-600 rounded-t-lg hover:text-green-600 transition duration-150" onclick="showTab('master-data')">Master Data</button>
        </div>

        <!-- Content Sections -->
        <div id="jobs-entry" class="tab-content bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">New Job & Income</h2>
            <form id="job-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="job-car-number" placeholder="Car Number (e.g., ABC-123)" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <input type="tel" id="job-customer-phone" placeholder="Customer Phone (optional)" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <input type="number" id="job-income-amount" placeholder="Income Amount ($)" required min="0.01" step="0.01" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <select id="job-payment-mode" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white">
                        <option value="" disabled selected>Payment Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI/Digital Wallet">UPI/Digital Wallet</option>
                    </select>
                </div>
                <!-- Payment Status Checkbox -->
                <div class="flex items-center space-x-3 mb-4">
                    <input type="checkbox" id="job-is-paid" checked class="h-5 w-5 text-green-600 border-gray-300 rounded focus:ring-green-500">
                    <label for="job-is-paid" class="text-gray-700 font-medium">Payment Received (Check if paid now)</label>
                </div>
                
                <!-- Service Description: Dropdown and Free Text (Dynamically populated) -->
                <div class="mb-4 space-y-3">
                    <select id="job-predefined-service" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white w-full">
                        <option value="" disabled selected>Loading Primary Services...</option>
                        <!-- Options will be added by JavaScript -->
                    </select>
                    <textarea id="job-free-text-description" placeholder="Specific Details (e.g., Replaced spark plugs, used synthetic oil, customer provided parts)" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150"></textarea>
                </div>

                <button type="submit" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition duration-150 shadow-md">Record Job Income</button>
            </form>
        </div>

        <div id="expenses-entry" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">New Expense or Salary</h2>
            <form id="expense-form">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="number" id="expense-amount" placeholder="Amount ($)" required min="0.01" step="0.01" class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <select id="expense-category" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white">
                        <option value="" disabled selected>Loading Categories...</option>
                        <!-- Options will be added by JavaScript -->
                    </select>
                    <select id="expense-payment-mode" required class="p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 bg-white">
                        <option value="" disabled selected>Payment Mode</option>
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
                <input type="text" id="expense-notes" placeholder="Notes (e.g., Paid John Doe Salary)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150 mb-4">
                <button type="submit" class="w-full py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">Record Expense/Salary</button>
            </form>
        </div>

        <div id="reports" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Financial Reports & Status</h2>

            <!-- Summary Status -->
            <div class="grid grid-cols-3 gap-4 mb-8">
                <div class="p-4 bg-green-50 border-l-4 border-green-500 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">Total Income (Realized - Today)</p>
                    <p id="daily-income" class="text-2xl font-bold text-green-700">$0.00</p>
                </div>
                <div class="p-4 bg-red-50 border-l-4 border-red-500 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">Total Expenses (Today)</p>
                    <p id="daily-expense" class="text-2xl font-bold text-red-700">$0.00</p>
                </div>
                <div class="p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg shadow-sm">
                    <p class="text-sm text-gray-500">Net Status (Today)</p>
                    <p id="daily-net" class="text-2xl font-bold text-blue-700">$0.00</p>
                </div>
            </div>

            <!-- Pending Transactions Section -->
            <h3 class="text-xl font-semibold mb-3 text-red-600 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Pending Payments
            </h3>
            <div id="pending-jobs-list" class="space-y-2 mb-8 max-h-48 overflow-y-auto p-2 border border-red-200 rounded-lg bg-red-50">
                <p class="text-center text-gray-500 p-4">No payments currently pending.</p>
            </div>


            <!-- Recent Activity -->
            <h3 class="text-xl font-semibold mb-3 text-gray-700">Recent Activity (All Transactions)</h3>
            <div id="activity-list" class="space-y-2 max-h-96 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-gray-50">
                <p class="text-center text-gray-400">Loading data...</p>
            </div>
        </div>
        
        <!-- Master Data Management Tab -->
        <div id="master-data" class="tab-content hidden bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold mb-6 text-gray-700">Master Data Management</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 1. Master Services Management -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-green-700 border-b pb-2">Predefined Job Services</h3>
                    <p class="text-sm text-gray-500 mb-4">These items populate the 'Primary Service' dropdown in Job Entry.</p>
                    
                    <form id="master-service-form" class="flex space-x-2 mb-6">
                        <input type="text" id="service-name" placeholder="New Service Name (e.g., Tire Rotation)" required class="flex-grow p-2 border border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <button type="submit" class="py-2 px-4 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 shadow-md">Add</button>
                    </form>
                    
                    <div id="master-services-list" class="space-y-2 max-h-72 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-center text-gray-400">Loading services...</p>
                    </div>
                </div>

                <!-- 2. Expense Categories Management -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-red-700 border-b pb-2">Expense Categories</h3>
                    <p class="text-sm text-gray-500 mb-4">These items populate the 'Category' dropdown in Expenses & Salaries.</p>

                    <form id="master-category-form" class="flex space-x-2 mb-6">
                        <input type="text" id="category-name" placeholder="New Category Name (e.g., Tools, Rent)" required class="flex-grow p-2 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                        <button type="submit" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 shadow-md">Add</button>
                    </form>

                    <div id="master-categories-list" class="space-y-2 max-h-72 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-center text-gray-400">Loading categories...</p>
                    </div>
                </div>

                <!-- 3. Employee Management -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-blue-700 border-b pb-2">Employee Management</h3>
                    <p class="text-sm text-gray-500 mb-4">Add, search, and manage staff members' active status.</p>
                    
                    <!-- Add Employee Form -->
                    <form id="master-employee-form" class="space-y-3 mb-6 p-3 bg-blue-50 rounded-lg">
                        <input type="text" id="employee-name" placeholder="Employee Name" required class="w-full p-2 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="employee-is-active" checked class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="employee-is-active" class="text-gray-700 font-medium">Is Active</label>
                        </div>

                        <button type="submit" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">Add Employee</button>
                    </form>
                    
                    <!-- Search Input (NEW) -->
                    <input type="text" id="employee-search" placeholder="Search employee name..." class="w-full p-2 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">

                    <div id="master-employees-list" class="space-y-2 max-h-72 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <p class="text-center text-gray-400">Loading employees...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, addDoc, onSnapshot, query, serverTimestamp, setLogLevel, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Provided by Environment) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- Global Data Stores ---
    let allEmployees = []; // Stores all employee documents for client-side filtering
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // Set Firestore log level for debugging
    setLogLevel('Debug');

    // --- UI Element References ---
    const loadingElement = document.getElementById('loading');
    const signInButton = document.getElementById('sign-in-button');
    const signOutButton = document.getElementById('sign-out-button');
    const userInfoElement = document.getElementById('user-info');
    const userDisplayNameElement = document.getElementById('user-display-name');
    const authStatusElement = document.getElementById('auth-status');
    const mainContentWrapper = document.getElementById('main-content-wrapper');

    // --- Utility Functions ---

    /** Displays a message box (success or error) */
    function showMessage(message, type = 'success') {
        const box = document.getElementById('message-box');
        box.textContent = message;
        box.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'text-red-700', 'bg-green-100', 'border-green-500', 'text-green-700', 'border-l-4', 'bg-yellow-100', 'border-yellow-500', 'text-yellow-700');

        if (type === 'error') {
            box.classList.add('bg-red-100', 'border-red-500', 'text-red-700', 'border-l-4');
        } else if (type === 'info') {
            box.classList.add('bg-yellow-100', 'border-yellow-500', 'text-yellow-700', 'border-l-4');
        } else {
            box.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'border-l-4');
        }
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 5000);
    }

    /** Formats a number as currency */
    const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    };

    /** Get the collection path for the current user's private data */
    const getCollectionPath = (collectionName) => {
        if (!userId) {
            // Should not happen if app is guarded, but good practice
            throw new Error("User ID is required for collection path.");
        }
        return `artifacts/${appId}/users/${userId}/${collectionName}`;
    };

    /** Switch between UI tabs */
    window.showTab = (tabId) => {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active', 'bg-green-500', 'text-white'));

        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById(`tab-${tabId.split('-')[0]}`).classList.add('active', 'bg-green-500', 'text-white');
    };

    // --- Google Authentication Functions ---

    window.signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
            // onAuthStateChanged handler will fire upon successful sign-in
        } catch (error) {
            console.error("Google Sign-In Failed:", error);
            // Handle specific errors like pop-up closed or access denied
            if (error.code !== 'auth/popup-closed-by-user') {
                showMessage(`Sign-in error: ${error.message}`, 'error');
            }
        }
    };

    window.signOutUser = async () => {
        try {
            await signOut(auth);
            showMessage("Signed out successfully. Data secured.");
        } catch (error) {
            console.error("Sign-Out Failed:", error);
            showMessage(`Sign-out error: ${error.message}`, 'error');
        }
    };


    // --- Firebase Initialization and Authentication ---
    async function initFirebase() {
        loadingElement.textContent = 'Initializing app...';
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // 1. Listen for Auth State Changes
            onAuthStateChanged(auth, async (user) => {
                loadingElement.classList.add('hidden'); // Hide initialization message

                if (user) {
                    // User is signed in
                    userId = user.uid;
                    isAuthReady = true;

                    // Update UI for signed-in state
                    userDisplayNameElement.textContent = user.displayName || 'Authenticated User';
                    authStatusElement.textContent = `User ID: ${userId.substring(0, 8)}...`;
                    userInfoElement.classList.remove('hidden');
                    signOutButton.classList.remove('hidden');
                    signInButton.classList.add('hidden');
                    mainContentWrapper.classList.remove('hidden');

                    console.log('User authenticated:', userId);
                    
                    // Start listening to data once authenticated
                    setupDataListeners();
                } else {
                    // User is signed out
                    userId = null;
                    isAuthReady = false;

                    // Update UI for signed-out state
                    userInfoElement.classList.add('hidden');
                    signOutButton.classList.add('hidden');
                    signInButton.classList.remove('hidden');
                    mainContentWrapper.classList.add('hidden');

                    // Attempt custom token sign-in if available (for continuous session)
                    if (initialAuthToken) {
                         loadingElement.textContent = 'Authenticating session...';
                         loadingElement.classList.remove('hidden');
                         await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Prompt user to sign in
                        showMessage("Please sign in to access the Car Service Manager.", 'info');
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            loadingElement.textContent = `Initialization Error. Check console.`;
            showMessage("Initialization failed. Please check the console for details.", 'error');
        }
    }

    // --- DYNAMIC DROPDOWN & LIST POPULATION FUNCTIONS ---

    /** Renders the master services list and updates the job form dropdown */
    function populateJobServices(services) {
        const select = document.getElementById('job-predefined-service');
        const listContainer = document.getElementById('master-services-list');
        select.innerHTML = '<option value="" disabled selected>Select Primary Service</option>';
        listContainer.innerHTML = '';
        
        if (services.length === 0) {
            select.innerHTML = '<option value="" disabled selected>No services defined. Add one in Master Data.</option>';
            listContainer.innerHTML = '<p class="text-center text-gray-400 p-4">No services defined yet.</p>';
            return;
        }

        services.forEach(service => {
            // Update Job Entry Dropdown
            const option = document.createElement('option');
            option.value = service.name;
            option.textContent = service.name;
            select.appendChild(option);

            // Update Master Data List
            const listItem = document.createElement('div');
            listItem.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm border border-green-200';
            listItem.innerHTML = `
                <span class="font-medium text-gray-700">${service.name}</span>
                <button onclick="deleteMasterItem('${service.id}', 'master_services')" class="py-1 px-2 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150">Delete</button>
            `;
            listContainer.appendChild(listItem);
        });
    }

    /** Renders the master categories list and updates the expense form dropdown */
    function populateExpenseCategories(categories) {
        const select = document.getElementById('expense-category');
        const listContainer = document.getElementById('master-categories-list');
        select.innerHTML = '<option value="" disabled selected>Select Category</option>';
        listContainer.innerHTML = '';
        
        if (categories.length === 0) {
            select.innerHTML = '<option value="" disabled selected>No categories defined. Add one in Master Data.</option>';
            listContainer.innerHTML = '<p class="text-center text-gray-400 p-4">No categories defined yet.</p>';
            return;
        }

        categories.forEach(category => {
            // Update Expense Entry Dropdown
            const option = document.createElement('option');
            option.value = category.name;
            option.textContent = category.name;
            select.appendChild(option);

            // Update Master Data List
            const listItem = document.createElement('div');
            listItem.className = 'flex justify-between items-center p-2 bg-white rounded-lg shadow-sm border border-red-200';
            listItem.innerHTML = `
                <span class="font-medium text-gray-700">${category.name}</span>
                <button onclick="deleteMasterItem('${category.id}', 'master_categories')" class="py-1 px-2 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150">Delete</button>
            `;
            listContainer.appendChild(listItem);
        });
    }

    /** Renders the master employee list with filtering capability */
    function populateEmployeeList(employeesToRender = allEmployees) {
        const listContainer = document.getElementById('master-employees-list');
        const searchTerm = document.getElementById('employee-search')?.value.toLowerCase() || '';
        
        // Filter based on search term
        const filteredEmployees = employeesToRender.filter(emp => 
            emp.name.toLowerCase().includes(searchTerm)
        );

        listContainer.innerHTML = ''; // Clear the list

        if (filteredEmployees.length === 0) {
            listContainer.innerHTML = `<p class="text-center text-gray-400 p-4">No employees match "${searchTerm}" or none defined yet.</p>`;
            return;
        }

        filteredEmployees.forEach(employee => {
            const statusClass = employee.isActive ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-yellow-100 text-yellow-700 border border-yellow-300';
            const statusText = employee.isActive ? 'Active' : 'Inactive';
            
            const toggleButtonColor = employee.isActive ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';
            const toggleButtonText = employee.isActive ? 'Set Inactive' : 'Set Active';

            const listItem = document.createElement('div');
            listItem.className = 'flex justify-between items-center p-3 bg-white rounded-xl shadow-sm border border-blue-200';
            listItem.innerHTML = `
                <div class="flex flex-col min-w-0">
                    <span class="font-semibold text-gray-800 truncate">${employee.name}</span>
                    <span class="text-xs font-medium ${statusClass} rounded-full px-2 py-0.5 mt-1 self-start">${statusText}</span>
                </div>
                <div class="flex space-x-2 flex-shrink-0">
                    <button onclick="toggleEmployeeStatus('${employee.id}', ${employee.isActive})" class="py-1 px-3 text-xs text-white rounded-lg transition duration-150 shadow-md ${toggleButtonColor}">
                        ${toggleButtonText}
                    </button>
                    <button onclick="deleteMasterItem('${employee.id}', 'master_employees')" class="py-1 px-3 text-xs bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition duration-150 shadow-md">Delete</button>
                </div>
            `;
            listContainer.appendChild(listItem);
        });
    }


    // --- Firestore WRITE OPERATIONS ---

    /** Handles submitting the Master Service form */
    document.getElementById('master-service-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return showMessage('Authentication required.', 'error');

        const nameInput = document.getElementById('service-name');
        const serviceName = nameInput.value.trim();

        if (serviceName) {
            try {
                const data = { name: serviceName, dateCreated: serverTimestamp() };
                await addDoc(collection(db, getCollectionPath('master_services')), data);
                showMessage(`Service '${serviceName}' added!`);
                nameInput.value = '';
            } catch (error) {
                console.error("Error adding service:", error);
                showMessage(`Error adding service: ${error.message}`, 'error');
            }
        }
    });

    /** Handles submitting the Master Category form */
    document.getElementById('master-category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return showMessage('Authentication required.', 'error');

        const nameInput = document.getElementById('category-name');
        const categoryName = nameInput.value.trim();

        if (categoryName) {
            try {
                const data = { name: categoryName, dateCreated: serverTimestamp() };
                await addDoc(collection(db, getCollectionPath('master_categories')), data);
                showMessage(`Category '${categoryName}' added!`);
                nameInput.value = '';
            } catch (error) {
                console.error("Error adding category:", error);
                showMessage(`Error adding category: ${error.message}`, 'error');
            }
        }
    });

    /** Handles submitting the Master Employee form */
    document.getElementById('master-employee-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return showMessage('Authentication required.', 'error');

        const nameInput = document.getElementById('employee-name');
        const activeInput = document.getElementById('employee-is-active');
        const employeeName = nameInput.value.trim();
        const isActive = activeInput.checked;

        if (employeeName) {
            try {
                const data = { 
                    name: employeeName, 
                    isActive: isActive,
                    dateCreated: serverTimestamp() 
                };
                await addDoc(collection(db, getCollectionPath('master_employees')), data);
                showMessage(`Employee '${employeeName}' added! Status: ${isActive ? 'Active' : 'Inactive'}`);
                nameInput.value = '';
                activeInput.checked = true; // Reset to active by default
            } catch (error) {
                console.error("Error adding employee:", error);
                showMessage(`Error adding employee: ${error.message}`, 'error');
            }
        }
    });
    
    /** Handles submitting the Job/Income form */
    document.getElementById('job-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return showMessage('Authentication required to save data.', 'error');

        const jobData = {
            carNumber: document.getElementById('job-car-number').value.trim(),
            customerPhone: document.getElementById('job-customer-phone').value.trim() || 'N/A',
            incomeAmount: parseFloat(document.getElementById('job-income-amount').value),
            paymentMode: document.getElementById('job-payment-mode').value, 
            isPaid: document.getElementById('job-is-paid').checked, 
            
            predefinedService: document.getElementById('job-predefined-service').value, 
            freeTextDescription: document.getElementById('job-free-text-description').value.trim() || 'No specific details provided.', 

            type: 'income',
            dateCreated: serverTimestamp(),
            recordedBy: userId 
        };

        try {
            await addDoc(collection(db, getCollectionPath('records')), jobData);
            if (jobData.isPaid) {
                showMessage('Job income recorded and PAID successfully!');
            } else {
                showMessage('Job recorded as PENDING PAYMENT.', 'info');
            }
            document.getElementById('job-form').reset();
        } catch (error) {
            console.error("Error adding job record:", error);
            showMessage(`Error recording job: ${error.message}`, 'error');
        }
    });

    /** Handles submitting the Expense/Salary form */
    document.getElementById('expense-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!isAuthReady) return showMessage('Authentication required to save data.', 'error');

        const expenseData = {
            amount: parseFloat(document.getElementById('expense-amount').value),
            category: document.getElementById('expense-category').value,
            paymentMode: document.getElementById('expense-payment-mode').value,
            notes: document.getElementById('expense-notes').value.trim(),
            type: 'expense',
            dateCreated: serverTimestamp(),
            recordedBy: userId 
        };

        try {
            await addDoc(collection(db, getCollectionPath('records')), expenseData);
            showMessage('Expense or Salary recorded successfully!', 'success');
            document.getElementById('expense-form').reset();
        } catch (error) {
            console.error("Error adding expense record:", error);
            showMessage(`Error recording expense: ${error.message}`, 'error');
        }
    });

    /** Function to mark a specific job as paid */
    window.markJobAsPaid = async (docId) => {
        if (!isAuthReady || !docId) return showMessage('Invalid request or not authenticated.', 'error');

        const jobRef = doc(db, getCollectionPath('records'), docId);
        try {
            // Update the document to mark it as paid
            await updateDoc(jobRef, {
                isPaid: true,
                paymentDate: serverTimestamp() 
            });
            showMessage(`Job marked as PAID! Realized income updated.`, 'success');
        } catch (error) {
            console.error("Error marking job as paid:", error);
            showMessage(`Error: Could not mark job as paid.`, 'error');
        }
    };
    
    /** Function to delete a master data item (Service, Category, or Employee) */
    window.deleteMasterItem = async (docId, collectionName) => {
        if (!isAuthReady || !docId || !collectionName) return showMessage('Invalid request or not authenticated.', 'error');

        const itemRef = doc(db, getCollectionPath(collectionName), docId);
        try {
            await deleteDoc(itemRef);
            showMessage(`Item deleted from ${collectionName.replace('master_', '')} list.`, 'info');
        } catch (error) {
            console.error("Error deleting master item:", error);
            showMessage(`Error deleting item: ${error.message}`, 'error');
        }
    };
    
    /** Function to toggle an employee's active status (NEW) */
    window.toggleEmployeeStatus = async (docId, currentStatus) => {
        if (!isAuthReady || !docId) return showMessage('Invalid request or not authenticated.', 'error');
        
        const employeeRef = doc(db, getCollectionPath('master_employees'), docId);
        const newStatus = !currentStatus;

        try {
            await updateDoc(employeeRef, { isActive: newStatus });
            showMessage(`Employee status updated to ${newStatus ? 'Active' : 'Inactive'}!`, 'info');
        } catch (error) {
            console.error("Error updating employee status:", error);
            showMessage(`Error updating status: ${error.message}`, 'error');
        }
    };


    // --- Firestore READ OPERATIONS (Reports and Master Data) ---

    let allRecords = [];

    function setupDataListeners() {
        if (!isAuthReady) return;

        // 1. Master Services Listener
        const masterServicesRef = collection(db, getCollectionPath('master_services'));
        onSnapshot(masterServicesRef, (snapshot) => {
            const services = [];
            snapshot.forEach(doc => services.push({ id: doc.id, ...doc.data() }));
            services.sort((a, b) => a.name.localeCompare(b.name));
            populateJobServices(services);
        }, (error) => {
            console.error("Error fetching master services:", error);
            showMessage("Could not load predefined services.", 'error');
        });

        // 2. Master Categories Listener
        const masterCategoriesRef = collection(db, getCollectionPath('master_categories'));
        onSnapshot(masterCategoriesRef, (snapshot) => {
            const categories = [];
            snapshot.forEach(doc => categories.push({ id: doc.id, ...doc.data() }));
            categories.sort((a, b) => a.name.localeCompare(b.name));
            populateExpenseCategories(categories);
        }, (error) => {
            console.error("Error fetching master categories:", error);
            showMessage("Could not load expense categories.", 'error');
        });

        // 3. Master Employees Listener
        const masterEmployeesRef = collection(db, getCollectionPath('master_employees'));
        onSnapshot(masterEmployeesRef, (snapshot) => {
            allEmployees = []; // Refresh global array
            snapshot.forEach(doc => allEmployees.push({ id: doc.id, ...doc.data() }));
            // Sort by isActive (true first) then by name
            allEmployees.sort((a, b) => b.isActive - a.isActive || a.name.localeCompare(b.name));
            populateEmployeeList(allEmployees); // Pass the full list to the renderer (which handles filtering)
        }, (error) => {
            console.error("Error fetching master employees:", error);
            showMessage("Could not load employee list.", 'error');
        });
        
        // 4. Records Listener (Income/Expenses)
        const recordsCollection = collection(db, getCollectionPath('records'));
        onSnapshot(recordsCollection, (snapshot) => {
            allRecords = [];
            snapshot.forEach((doc) => {
                allRecords.push({ id: doc.id, ...doc.data() });
            });
            // Sort client-side by dateCreated (newest first)
            allRecords.sort((a, b) => (b.dateCreated?.toMillis() || 0) - (a.dateCreated?.toMillis() || 0));

            updateReportsUI(allRecords);
        }, (error) => {
            console.error("Error fetching records:", error);
            showMessage("Could not load real-time financial data.", 'error');
        });
    }

    /** Updates the Report UI based on the fetched data */
    function updateReportsUI(records) {
        const today = new Date().toDateString();
        // Initialize aggregation variables
        let dailyIncomeRealized = 0; // Only PAID jobs
        let dailyExpense = 0;
        let pendingJobs = []; // List of unpaid income records

        const activityList = document.getElementById('activity-list');
        activityList.innerHTML = '';

        if (records.length === 0) {
            // Reset all lists/totals if no data
            document.getElementById('daily-income').textContent = formatCurrency(0);
            document.getElementById('daily-expense').textContent = formatCurrency(0);
            document.getElementById('daily-net').textContent = formatCurrency(0);
            document.getElementById('pending-jobs-list').innerHTML = '<p class="text-center text-gray-500 p-4">No payments currently pending.</p>';
            activityList.innerHTML = '<p class="text-center text-gray-400 p-4">No activity recorded yet.</p>';
            return;
        }

        records.forEach(record => {
            // Ensure dateCreated exists before processing
            if (!record.dateCreated || !record.dateCreated.toDate) return;

            const dateObject = record.dateCreated.toDate();
            const recordDateString = dateObject.toDateString();
            
            // Time period checks
            const isToday = recordDateString === today;

            // Aggregation
            const amount = record.type === 'income' ? record.incomeAmount : record.amount;

            if (record.type === 'income') {
                if (record.isPaid) {
                    // Realized Income aggregation (Paid Jobs Only)
                    if (isToday) dailyIncomeRealized += amount;
                } else {
                    // Pending Income
                    pendingJobs.push(record);
                }
            } else if (record.type === 'expense') {
                // Expense aggregation (Expenses are always "realized" when recorded)
                if (isToday) dailyExpense += amount;
            }

            // Populate Activity List (All Transactions)
            const item = document.createElement('div');
            let itemClass = record.type === 'income' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800';
            let statusBadge = '';

            if (record.type === 'income' && !record.isPaid) {
                // Highlight pending status in the full activity list
                itemClass = 'bg-yellow-50 text-yellow-800 border-l-4 border-yellow-500';
                statusBadge = '<span class="text-xs font-bold bg-yellow-400 text-white rounded-full px-2 py-0.5 ml-2">PENDING</span>';
            } else if (record.type === 'income' && record.isPaid) {
                itemClass = 'bg-green-50 text-green-800 border-l-4 border-green-500';
            } else if (record.type === 'expense') {
                itemClass = 'bg-red-50 text-red-800 border-l-4 border-red-500';
            }


            item.className = `p-3 rounded-lg flex justify-between items-center text-sm ${itemClass}`;

            let descriptionText = '';
            let amountText = '';

            if (record.type === 'income') {
                const paymentMode = record.paymentMode || 'N/A';
                
                // COMBINING NEW FIELDS for display
                const combinedDescription = `${record.predefinedService || 'Service'} — ${record.freeTextDescription || 'No specifics.'}`;
                const truncatedDescription = combinedDescription.split('\n')[0]; 
                
                descriptionText = `<span class="font-bold mr-1">(${paymentMode})</span> ${record.carNumber} - ${truncatedDescription}`;
                amountText = `+${formatCurrency(record.incomeAmount)}`;
            } else if (record.type === 'expense') {
                descriptionText = `${record.category} (${record.paymentMode}) - ${record.notes}`;
                amountText = `-${formatCurrency(record.amount)}`;
            }
            
            const dateDisplay = dateObject.toLocaleTimeString() + ' ' + dateObject.toLocaleDateString();

            item.innerHTML = `
                <div class="flex-1 min-w-0 flex items-center">
                    <span class="font-semibold">${descriptionText}</span>
                    ${statusBadge}
                    <span class="text-xs text-gray-500 ml-4">${dateDisplay}</span>
                </div>
                <span class="font-bold whitespace-nowrap">${amountText}</span>
            `;
            activityList.appendChild(item);
        });

        // 1. Update Pending Jobs List
        const pendingList = document.getElementById('pending-jobs-list');
        pendingList.innerHTML = '';
        if (pendingJobs.length === 0) {
            pendingList.innerHTML = '<p class="text-center text-gray-500 p-4">No payments currently pending.</p>';
        } else {
            pendingJobs.forEach(job => {
                const item = document.createElement('div');
                item.className = 'p-3 border border-red-300 rounded-lg flex justify-between items-center bg-white shadow-sm';
                
                const dateDisplay = job.dateCreated ? job.dateCreated.toDate().toLocaleDateString() : 'N/A';
                const paymentMode = job.paymentMode || 'N/A';
                
                // COMBINING NEW FIELDS for pending list
                const combinedDescription = `${job.predefinedService || 'Service'} — ${job.freeTextDescription || 'No specifics.'}`;
                const truncatedDescription = combinedDescription.split('\n')[0];

                item.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-red-700">${formatCurrency(job.incomeAmount)} DUE (${paymentMode})</p>
                        <p class="text-xs text-gray-600 truncate">${job.carNumber} - ${truncatedDescription} (Invoiced: ${dateDisplay})</p>
                    </div>
                    <button onclick="markJobAsPaid('${job.id}')" class="ml-4 py-1 px-3 text-xs bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 whitespace-nowrap shadow-md">
                        Mark Paid
                    </button>
                `;
                pendingList.appendChild(item);
            });
        }


        // 2. Update Summary Display (Daily) - Use Realized Income
        const dailyNet = dailyIncomeRealized - dailyExpense;
        document.getElementById('daily-income').textContent = formatCurrency(dailyIncomeRealized); // Use Realized Income
        document.getElementById('daily-expense').textContent = formatCurrency(dailyExpense);
        
        const netElement = document.getElementById('daily-net');
        netElement.textContent = formatCurrency(dailyNet);
        netElement.classList.remove('text-blue-700', 'text-green-700', 'text-red-700');
        if (dailyNet > 0) {
             netElement.classList.add('text-green-700');
        } else if (dailyNet < 0) {
             netElement.classList.add('text-red-700');
        } else {
             netElement.classList.add('text-blue-700');
        }
    }

    // --- Application Start ---
    window.onload = () => {
        initFirebase();
        // Attach listener to the search bar once the document is fully loaded
        document.getElementById('employee-search').addEventListener('input', () => {
             // Re-run the list population function with the stored global data, which will apply the filter
            populateEmployeeList(allEmployees);
        });
        showTab('jobs-entry'); 
    };

</script>
</body>
</html>
